name: Build and Deploy to EC2

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Set repository lowercase
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker build -t ghcr.io/${{ env.REPO_LC }}/mr-convert:latest .

      - name: Push Docker image
        run: docker push ghcr.io/${{ env.REPO_LC }}/mr-convert:latest

      - name: Save image name for deploy
        id: image_name
        run: echo "image=ghcr.io/${{ env.REPO_LC }}/mr-convert:latest" >> $GITHUB_OUTPUT

    outputs:
      image: ${{ steps.image_name.outputs.image }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to EC2 via SSH with Full Cleanup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Iniciando deploy con limpieza completa..."
            
            # 1. Login a GitHub Container Registry
            echo "ğŸ” Autenticando en GHCR..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 2. Detener y eliminar contenedores existentes
            echo "ğŸ›‘ Deteniendo contenedores existentes..."
            docker stop $(docker ps -aq) 2>/dev/null || echo "No hay contenedores corriendo"
            
            echo "ğŸ—‘ï¸ Eliminando contenedores existentes..."
            docker rm $(docker ps -aq) 2>/dev/null || echo "No hay contenedores para eliminar"
            
            # 3. Eliminar TODAS las imÃ¡genes Docker
            echo "ğŸ§¹ Eliminando todas las imÃ¡genes Docker..."
            docker rmi $(docker images -q) --force 2>/dev/null || echo "No hay imÃ¡genes para eliminar"
            
            # 4. Limpiar sistema Docker completo
            echo "ğŸ”„ Limpieza profunda del sistema Docker..."
            docker system prune -af --volumes 2>/dev/null || echo "Sistema ya limpio"
            
            # 5. Verificar espacio en disco despuÃ©s de limpieza
            echo "ğŸ’¾ Verificando espacio disponible:"
            df -h /
            
            # 6. Descargar la nueva imagen
            echo "â¬‡ï¸ Descargando nueva imagen..."
            docker pull ${{ needs.build.outputs.image }}
            
            # 7. Verificar que la imagen se descargÃ³ correctamente
            echo "âœ… Verificando imagen descargada:"
            docker images | grep mr-convert
            
            # 8. Crear directorio temporal si no existe
            echo "ğŸ“ Preparando directorios..."
            mkdir -p ~/temp
            
            # 9. Ejecutar nuevo contenedor
            echo "ğŸš€ Iniciando nuevo contenedor..."
            docker run -d --name mr-convert \
              --restart unless-stopped \
              -v ~/temp:/app/temp \
              -e BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
              -e TEMP_DIR=/app/temp \
              ${{ needs.build.outputs.image }}
            
            # 10. Verificar que el contenedor estÃ© corriendo
            echo "ğŸ” Verificando estado del contenedor:"
            docker ps
            
            # 11. Mostrar logs iniciales
            echo "ğŸ“œ Logs iniciales del bot:"
            docker logs mr-convert --tail 20
            
            # 12. Mostrar estado final del sistema
            echo "ğŸ“Š Estado final del sistema:"
            echo "Contenedores activos:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "Uso de memoria:"
            free -h
            echo ""
            echo "Espacio en disco:"
            df -h /
            
            echo "âœ… Deploy completado exitosamente!"